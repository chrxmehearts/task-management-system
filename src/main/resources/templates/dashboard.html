<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tasks — TaskFlow</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link th:href="@{/css/app.css}" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@2.0.3"></script>
    <script defer src="https://unpkg.com/alpinejs@3.14.3/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.3/Sortable.min.js"></script>
</head>
<body>

    <div class="dashboard-layout"
         x-data="{
           modalOpen: false,
           editOpen: false,
           editTask: { id: null, title: '', description: '', status: 'TODO', priority: 'MEDIUM', dueDate: '' },
           deleteOpen: false,
           deleteId: null
         }"
         @task-created.window="modalOpen = false"
         @edit-saved.window="editOpen = false"
         @open-edit.document="editTask = $event.detail; editOpen = true"
         @open-delete.document="deleteId = $event.detail; deleteOpen = true">

        <aside class="sidebar">
            <a href="/" class="sidebar-logo">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                TaskFlow
            </a>
            <nav class="sidebar-nav">
                <a href="/dashboard" class="sidebar-nav-item active">
                    <svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                    My Tasks
                </a>
                <a href="/stats" class="sidebar-nav-item">
                    <svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                    Statistics
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-avatar" th:text="${session.username != null ? session.username.substring(0,1).toUpperCase() : '?'}">U</div>
                    <span class="sidebar-username" th:text="${session.username ?: 'User'}">User</span>
                </div>
                <form th:action="@{/ui/logout}" method="post" style="margin:0">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button type="submit" class="sidebar-logout-btn" title="Log out">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    </button>
                </form>
            </div>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h1>My Tasks</h1>
                <button @click="modalOpen = true" class="btn-primary">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    New Task
                </button>
            </div>

            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-card-label">Total</div>
                    <div class="stat-card-value" id="stat-total">—</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">In Progress</div>
                    <div class="stat-card-value" id="stat-progress">—</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Done</div>
                    <div class="stat-card-value" id="stat-done">—</div>
                </div>
            </div>

            <!-- Hidden HTMX target — JS redistributes cards into the columns below -->
            <div id="task-list" style="display:none"
                 hx-get="/ui/tasks/list"
                 hx-trigger="load"
                 hx-swap="innerHTML"></div>

            <div class="kanban-board">

                <!-- TODO -->
                <div class="kanban-column kanban-col-todo">
                    <div class="kanban-col-header">
                        <span class="kanban-dot dot-todo"></span>
                        <span class="kanban-col-title">Todo</span>
                        <span class="kanban-col-count" id="count-todo">—</span>
                        <div class="kanban-sort-wrap">
                            <select class="kanban-sort" id="sort-todo" onchange="sortColumn('todo')">
                                <option value="priority">Priority</option>
                                <option value="due-asc">Due Date</option>
                                <option value="overdue">Overdue First</option>
                                <option value="created-desc">Newest</option>
                                <option value="title">A → Z</option>
                            </select>
                        </div>
                    </div>
                    <div class="kanban-col-body" id="body-todo">
                        <div class="col-empty">Loading…</div>
                    </div>
                </div>

                <!-- IN PROGRESS -->
                <div class="kanban-column kanban-col-progress">
                    <div class="kanban-col-header">
                        <span class="kanban-dot dot-progress"></span>
                        <span class="kanban-col-title">In Progress</span>
                        <span class="kanban-col-count" id="count-progress">—</span>
                        <div class="kanban-sort-wrap">
                            <select class="kanban-sort" id="sort-progress" onchange="sortColumn('progress')">
                                <option value="priority">Priority</option>
                                <option value="due-asc">Due Date</option>
                                <option value="overdue">Overdue First</option>
                                <option value="created-desc">Newest</option>
                                <option value="title">A → Z</option>
                            </select>
                        </div>
                    </div>
                    <div class="kanban-col-body" id="body-progress">
                        <div class="col-empty">Loading…</div>
                    </div>
                </div>

                <!-- DONE -->
                <div class="kanban-column kanban-col-done">
                    <div class="kanban-col-header">
                        <span class="kanban-dot dot-done"></span>
                        <span class="kanban-col-title">Done</span>
                        <span class="kanban-col-count" id="count-done">—</span>
                        <div class="kanban-sort-wrap">
                            <select class="kanban-sort" id="sort-done" onchange="sortColumn('done')">
                                <option value="priority">Priority</option>
                                <option value="due-asc">Due Date</option>
                                <option value="created-desc">Newest</option>
                                <option value="title">A → Z</option>
                            </select>
                        </div>
                    </div>
                    <div class="kanban-col-body" id="body-done">
                        <div class="col-empty">Loading…</div>
                    </div>
                </div>

            </div>
        </main>

        <!-- Create Task Modal -->
        <div class="modal-overlay" :class="{ open: modalOpen }" @click.self="modalOpen = false" @keydown.escape.window="modalOpen = false">
            <div class="modal">
                <h3>New Task</h3>
                <form hx-post="/ui/tasks/create"
                      hx-target="#task-list"
                      hx-swap="innerHTML"
                      hx-on:htmx:after-request="if(event.detail.successful) { this.reset(); window.dispatchEvent(new Event('task-created')); }">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <div class="form-group">
                        <label for="title">Title</label>
                        <input type="text" id="title" name="title" placeholder="What needs to be done?" required autofocus>
                    </div>
                    <div class="form-group">
                        <label for="description">Description <span style="color:var(--color-text-faint);font-weight:400">(optional)</span></label>
                        <textarea id="description" name="description" placeholder="Add more detail…"></textarea>
                    </div>
                    <div class="form-row-2">
                        <div class="form-group">
                            <label for="priority">Priority</label>
                            <select id="priority" name="priority">
                                <option value="LOW">Low</option>
                                <option value="MEDIUM" selected>Medium</option>
                                <option value="HIGH">High</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status" name="status">
                                <option value="TODO" selected>Todo</option>
                                <option value="IN_PROGRESS">In Progress</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="dueDate">Due Date <span style="color:var(--color-text-faint);font-weight:400">(optional)</span></label>
                        <input type="date" id="dueDate" name="dueDate">
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" @click="modalOpen = false">Cancel</button>
                        <button type="submit" class="btn-primary">Create Task</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit / Manage Task Modal -->
        <div class="modal-overlay" :class="{ open: editOpen }" @click.self="editOpen = false" @keydown.escape.window="editOpen = false">
            <div class="modal">
                <h3>Manage Task</h3>
                <form hx-post="/ui/tasks/update"
                      hx-target="#task-list"
                      hx-swap="innerHTML"
                      hx-on:htmx:after-request="if(event.detail.successful) window.dispatchEvent(new Event('edit-saved'));">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <input type="hidden" name="taskId" :value="editTask.id">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" name="title" x-model="editTask.title" required>
                    </div>
                    <div class="form-group">
                        <label>Description <span style="color:var(--color-text-faint);font-weight:400">(optional)</span></label>
                        <textarea name="description" x-model="editTask.description"></textarea>
                    </div>
                    <div class="form-row-2">
                        <div class="form-group">
                            <label>Status</label>
                            <select name="status" x-model="editTask.status">
                                <option value="TODO">Todo</option>
                                <option value="IN_PROGRESS">In Progress</option>
                                <option value="DONE">Done</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Priority</label>
                            <select name="priority" x-model="editTask.priority">
                                <option value="LOW">Low</option>
                                <option value="MEDIUM">Medium</option>
                                <option value="HIGH">High</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Due Date <span style="color:var(--color-text-faint);font-weight:400">(optional)</span></label>
                        <input type="date" name="dueDate" x-model="editTask.dueDate">
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" @click="editOpen = false">Cancel</button>
                        <button type="submit" class="btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal-overlay" :class="{ open: deleteOpen }" @click.self="deleteOpen = false" @keydown.escape.window="deleteOpen = false">
            <div class="modal modal-sm">
                <div class="modal-danger-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                        <path d="M10 11v6"/><path d="M14 11v6"/>
                        <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
                    </svg>
                </div>
                <h3>Delete Task</h3>
                <p class="modal-body-text">Are you sure you want to delete this task? This action cannot be undone.</p>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" @click="deleteOpen = false">Cancel</button>
                    <button type="button" class="btn-danger-solid"
                            @click="htmx.ajax('DELETE', '/ui/tasks/' + deleteId, { target: '#task-list', swap: 'innerHTML' }); deleteOpen = false">
                        Delete
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('htmx:configRequest', function(evt) {
            var match = document.cookie.match(/(?:^|;\s*)XSRF-TOKEN=([^;]+)/);
            if (match) evt.detail.headers['X-XSRF-TOKEN'] = decodeURIComponent(match[1]);
        });

        var TODAY = new Date().toISOString().split('T')[0];
        var PRI   = { HIGH: 0, MEDIUM: 1, LOW: 2 };

        var COL_STATUS = { 'body-todo': 'TODO', 'body-progress': 'IN_PROGRESS', 'body-done': 'DONE' };
        var STATUS_LABEL = { TODO: 'Todo', IN_PROGRESS: 'In Progress', DONE: 'Done' };
        var sortableReady = false;

        function getCsrfToken() {
            var m = document.cookie.match(/(?:^|;\s*)XSRF-TOKEN=([^;]+)/);
            return m ? decodeURIComponent(m[1]) : '';
        }

        function syncEmptyState(colBody) {
            var has = colBody.querySelectorAll('.task-card').length > 0;
            var existing = colBody.querySelector('.col-empty');
            if (!has && !existing) {
                var d = document.createElement('div');
                d.className = 'col-empty';
                d.textContent = 'Nothing here';
                colBody.appendChild(d);
            } else if (has && existing) {
                existing.remove();
            }
        }

        function updateAllCounts() {
            var cT = document.querySelectorAll('#body-todo .task-card').length;
            var cP = document.querySelectorAll('#body-progress .task-card').length;
            var cD = document.querySelectorAll('#body-done .task-card').length;
            document.getElementById('count-todo').textContent     = cT;
            document.getElementById('count-progress').textContent = cP;
            document.getElementById('count-done').textContent     = cD;
            document.getElementById('stat-total').textContent    = cT + cP + cD;
            document.getElementById('stat-progress').textContent = cP;
            document.getElementById('stat-done').textContent     = cD;
        }

        function updateCardForStatus(card, newStatus) {
            card.dataset.status = newStatus;

            var badge = card.querySelector('[class*="badge-status-"]');
            if (badge) {
                badge.className = badge.className.replace(/badge-status-\S+/g, '').trim();
                badge.classList.add('badge-status-' + newStatus);
                badge.textContent = STATUS_LABEL[newStatus] || newStatus;
            }

            var overdue = newStatus !== 'DONE' && card.dataset.dueDate && card.dataset.dueDate < TODAY;
            card.classList.toggle('is-overdue', !!overdue);

            var doneBtn = card.querySelector('.btn-done');
            if (newStatus === 'DONE') {
                if (doneBtn) doneBtn.style.display = 'none';
            } else {
                if (doneBtn) {
                    doneBtn.style.display = '';
                } else {
                    var actions = card.querySelector('.task-actions');
                    var delBtn  = actions && actions.querySelector('.btn-danger');
                    var btn = document.createElement('button');
                    btn.className = 'btn-sm btn-done';
                    btn.textContent = '✓ Done';
                    btn.setAttribute('hx-post', '/ui/tasks/' + card.dataset.id + '/done');
                    btn.setAttribute('hx-target', '#task-list');
                    btn.setAttribute('hx-swap', 'innerHTML');
                    htmx.process(btn);
                    if (actions) actions.insertBefore(btn, delBtn || null);
                }
            }
        }

        function initSortable() {
            if (sortableReady) return;
            sortableReady = true;
            ['body-todo', 'body-progress', 'body-done'].forEach(function(bodyId) {
                var el = document.getElementById(bodyId);
                if (!el) return;
                Sortable.create(el, {
                    group:       'tasks',
                    animation:   200,
                    easing:      'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
                    ghostClass:  'task-ghost',
                    chosenClass: 'task-chosen',
                    dragClass:   'task-dragging',
                    filter:      '.col-empty',
                    onEnd: function(evt) {
                        if (evt.from === evt.to) return;
                        var card      = evt.item;
                        var newStatus = COL_STATUS[evt.to.id];
                        if (!newStatus) return;
                        updateCardForStatus(card, newStatus);
                        syncEmptyState(evt.from);
                        syncEmptyState(evt.to);
                        updateAllCounts();
                        var fd = new FormData();
                        fd.append('status', newStatus);
                        fetch('/ui/tasks/' + card.dataset.id + '/status', {
                            method:  'POST',
                            headers: { 'X-XSRF-TOKEN': getCsrfToken() },
                            body:    fd
                        }).then(function(r) {
                            if (r.status === 401) window.location.href = '/login';
                        });
                    }
                });
            });
        }

        function compareDueDate(a, b) {
            var ad = a.dataset.dueDate || '', bd = b.dataset.dueDate || '';
            if (!ad && !bd) return 0;
            if (!ad) return 1;
            if (!bd) return -1;
            return ad < bd ? -1 : ad > bd ? 1 : 0;
        }

        function sortCards(container, by) {
            var cards = Array.from(container.querySelectorAll('.task-card'));
            if (cards.length < 2) return;
            cards.sort(function(a, b) {
                if (by === 'priority') {
                    var d = (PRI[a.dataset.priority] ?? 3) - (PRI[b.dataset.priority] ?? 3);
                    return d !== 0 ? d : compareDueDate(a, b);
                }
                if (by === 'due-asc') return compareDueDate(a, b);
                if (by === 'overdue') {
                    var ao = (a.dataset.dueDate && a.dataset.dueDate < TODAY) ? 0 : 1;
                    var bo = (b.dataset.dueDate && b.dataset.dueDate < TODAY) ? 0 : 1;
                    if (ao !== bo) return ao - bo;
                    return compareDueDate(a, b);
                }
                if (by === 'created-desc') {
                    var ac = a.dataset.createdAt || '', bc = b.dataset.createdAt || '';
                    return bc < ac ? -1 : bc > ac ? 1 : 0;
                }
                if (by === 'title') return (a.dataset.title || '').localeCompare(b.dataset.title || '');
                return 0;
            });
            cards.forEach(function(c) { container.appendChild(c); });
        }

        function sortColumn(col) {
            var body = document.getElementById('body-' + col);
            var sel  = document.getElementById('sort-' + col);
            if (body && sel) sortCards(body, sel.value);
        }

        function distributeAndSort() {
            var src   = document.getElementById('task-list');
            var bTodo = document.getElementById('body-todo');
            var bProg = document.getElementById('body-progress');
            var bDone = document.getElementById('body-done');

            bTodo.innerHTML = ''; bProg.innerHTML = ''; bDone.innerHTML = '';
            var cT = 0, cP = 0, cD = 0;

            src.querySelectorAll('.task-card').forEach(function(card) {
                var s = card.dataset.status;
                var overdue = s !== 'DONE' && card.dataset.dueDate && card.dataset.dueDate < TODAY;
                card.classList.toggle('is-overdue', !!overdue);
                if      (s === 'TODO')        { bTodo.appendChild(card); cT++; }
                else if (s === 'IN_PROGRESS') { bProg.appendChild(card); cP++; }
                else if (s === 'DONE')        { bDone.appendChild(card); cD++; }
            });

            var empty = '<div class="col-empty">Nothing here</div>';
            if (cT === 0) bTodo.innerHTML = empty;
            if (cP === 0) bProg.innerHTML = empty;
            if (cD === 0) bDone.innerHTML = empty;

            if (cT > 0) sortCards(bTodo, document.getElementById('sort-todo').value);
            if (cP > 0) sortCards(bProg, document.getElementById('sort-progress').value);
            if (cD > 0) sortCards(bDone, document.getElementById('sort-done').value);

            document.getElementById('stat-total').textContent    = cT + cP + cD;
            document.getElementById('stat-progress').textContent = cP;
            document.getElementById('stat-done').textContent     = cD;
            document.getElementById('count-todo').textContent     = cT;
            document.getElementById('count-progress').textContent = cP;
            document.getElementById('count-done').textContent     = cD;

            initSortable();
        }

        document.body.addEventListener('htmx:afterSettle', function(evt) {
            if (evt.detail.target.id === 'task-list') distributeAndSort();
        });

        function openManageModal(btn) {
            var card = btn.closest('.task-card');
            document.dispatchEvent(new CustomEvent('open-edit', { detail: {
                id:          card.dataset.id,
                title:       card.dataset.title,
                description: card.dataset.description || '',
                status:      card.dataset.status,
                priority:    card.dataset.priority,
                dueDate:     card.dataset.dueDate || ''
            }}));
        }

        function openDeleteModal(id) {
            document.dispatchEvent(new CustomEvent('open-delete', { detail: id }));
        }
    </script>

</body>
</html>
